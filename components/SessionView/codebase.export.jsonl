{"rootPath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView","skipMinified":true,"generatedAt":"2026-01-28T14:23:17.2716407+01:00","maxBytesPerFile":262144,"_type":"codebase_header","format":"jsonl"}
{"lineCount":365,"fileName":"SessionItem.tsx","content":"\u0027use client\u0027;\n\nimport React, { useEffect, useMemo, useState } from \u0027react\u0027;\nimport { Copy, Edit3, MoreHorizontal, Sparkles } from \u0027lucide-react\u0027;\nimport { useRouter } from \u0027next/navigation\u0027;\nimport type { Session } from \u0027./types\u0027;\nimport {\n  classifyWord,\n  computeAnalysis,\n  splitPreservingWhitespace,\n  type WordClass,\n  type Highlight,\n} from \u0027@/lib/textAnalysis\u0027;\nimport { useCopyToClipboard } from \u0027@/hooks/useCopyToClipboard\u0027;\n\ninterface SessionItemProps {\n  session: Session;\n  onUpdate?: (\n    id: number,\n    payload: Partial\u003cPick\u003cSession, \u0027title\u0027 | \u0027status\u0027 | \u0027tags\u0027\u003e\u003e,\n  ) =\u003e Promise\u003c{ success: boolean; error?: string } | { success: boolean }\u003e;\n  disableActions?: boolean;\n}\n\nconst classToSpan = (cls: WordClass) =\u003e {\n  if (cls === \u0027verb\u0027) return \u0027analysis-verb\u0027;\n  if (cls === \u0027noun\u0027) return \u0027analysis-noun\u0027;\n  if (cls === \u0027adverb\u0027) return \u0027analysis-adverb\u0027;\n  return \u0027\u0027;\n};\n\nconst statusLabels: Record\u003cNonNullable\u003cSession[\u0027status\u0027]\u003e, string\u003e = {\n  draft: \u0027Roh\u0027,\n  in_progress: \u0027In Arbeit\u0027,\n  revised: \u0027Überarbeitet\u0027,\n  final: \u0027Final\u0027,\n};\n\nexport function SessionItem({ session, onUpdate, disableActions }: SessionItemProps) {\n  const router = useRouter();\n  const {\n    id,\n    text,\n    title,\n    status = \u0027draft\u0027,\n    tags = [],\n    created_at,\n    updated_at,\n    letter_count,\n    word_count,\n    char_count,\n  } = session;\n\n  const [showAnalysis, setShowAnalysis] = useState(false);\n  const [analysis, setAnalysis] = useState\u003cReturnType\u003ctypeof computeAnalysis\u003e | null\u003e(null);\n  const [isEditingTitle, setIsEditingTitle] = useState(false);\n  const [draftTitle, setDraftTitle] = useState(title ?? \u0027\u0027);\n  const [newTag, setNewTag] = useState(\u0027\u0027);\n  const { copied, copy } = useCopyToClipboard(1500);\n\n  const safeWordCount = word_count ?? 0;\n  const safeCharCount = char_count ?? 0;\n  const safeLetterCount = letter_count ?? 0;\n\n  const paragraphs = useMemo(() =\u003e {\n    const t = text.trim();\n    if (!t) return [];\n    return t.split(/\\n{2,}/);\n  }, [text]);\n\n  useEffect(() =\u003e {\n    setDraftTitle(title ?? \u0027\u0027);\n  }, [title]);\n\n  useEffect(() =\u003e {\n    if (showAnalysis) {\n      setAnalysis(computeAnalysis(text));\n    }\n  }, [showAnalysis, text]);\n\n  const counts = analysis?.counts ?? {\n    verbs: 0,\n    nouns: 0,\n    adjectives: 0,\n    adverbs: 0,\n  };\n  const highlights = analysis?.highlights ?? [];\n\n  // Cache classifications so we don\u0027t re-run classifyWord for identical tokens\n  const classifier = useMemo(() =\u003e {\n    const cache = new Map\u003cstring, WordClass\u003e();\n    return (token: string) =\u003e {\n      const hit = cache.get(token);\n      if (hit) return hit;\n      const cls = classifyWord(token, false);\n      cache.set(token, cls);\n      return cls;\n    };\n  }, []);\n\n  const handleEdit = () =\u003e {\n    router.push(`/session?active=${encodeURIComponent(String(id))}`);\n  };\n\n  const handleCopy = async () =\u003e {\n    try {\n      await copy(text);\n    } catch (err) {\n      console.error(\u0027Konnte nicht kopieren\u0027, err);\n    }\n  };\n\n  const handleSaveTitle = async () =\u003e {\n    if (!onUpdate) {\n      setIsEditingTitle(false);\n      return;\n    }\n    if (!isEditingTitle) {\n      setIsEditingTitle(true);\n      return;\n    }\n    const nextTitle = draftTitle.trim();\n    try {\n      await onUpdate(id, { title: nextTitle.length \u003e 0 ? nextTitle : null });\n    } catch (err) {\n      console.error(\u0027Titel konnte nicht aktualisiert werden\u0027, err);\n    } finally {\n      setIsEditingTitle(false);\n    }\n  };\n\n  const handleStatusChange = async (nextStatus: NonNullable\u003cSession[\u0027status\u0027]\u003e) =\u003e {\n    if (!onUpdate) return;\n    try {\n      await onUpdate(id, { status: nextStatus });\n    } catch (err) {\n      console.error(\u0027Status konnte nicht aktualisiert werden\u0027, err);\n    }\n  };\n\n  const handleAddTag = async () =\u003e {\n    if (!onUpdate) return;\n    const t = newTag.trim();\n    if (!t) return;\n    const nextTags = Array.from(new Set([...(tags ?? []), t]));\n    try {\n      await onUpdate(id, { tags: nextTags });\n      setNewTag(\u0027\u0027);\n    } catch (err) {\n      console.error(\u0027Tag konnte nicht hinzugefügt werden\u0027, err);\n    }\n  };\n\n  const handleRemoveTag = async (tag: string) =\u003e {\n    if (!onUpdate) return;\n    const nextTags = (tags ?? []).filter((t) =\u003e t.toLowerCase() !== tag.toLowerCase());\n    try {\n      await onUpdate(id, { tags: nextTags });\n    } catch (err) {\n      console.error(\u0027Tag konnte nicht entfernt werden\u0027, err);\n    }\n  };\n\n  const renderParagraph = (para: string, idx: number) =\u003e {\n    if (!showAnalysis) {\n      return (\n        \u003cp key={`${id}-p-${idx}`} className=\"whitespace-pre-wrap\"\u003e\n          {para}\n        \u003c/p\u003e\n      );\n    }\n\n    const tokens = splitPreservingWhitespace(para);\n    const baseIndex = paragraphs\n      .slice(0, idx)\n      .reduce((acc, cur) =\u003e acc + splitPreservingWhitespace(cur).length, 0);\n\n    return (\n      \u003cp key={`${id}-p-${idx}`} className=\"whitespace-pre-wrap\"\u003e\n        {tokens.map((token, tokenIdx) =\u003e {\n          if (!token || !token.trim()) {\n            return \u003cReact.Fragment key={tokenIdx}\u003e{token}\u003c/React.Fragment\u003e;\n          }\n\n          const globalIndex = baseIndex + tokenIdx;\n          const hit: Highlight | undefined = highlights.find((h) =\u003e h.index === globalIndex);\n          const cls = classifier(token);\n          if (cls === \u0027none\u0027) {\n            return \u003cReact.Fragment key={tokenIdx}\u003e{token}\u003c/React.Fragment\u003e;\n          }\n\n          const types: string[] = [];\n          types.push(classToSpan(cls));\n          if (hit?.type === \u0027nominalStyle\u0027) types.push(\u0027analysis-nominal\u0027);\n          if (hit?.type === \u0027deadVerb\u0027) types.push(\u0027analysis-deadverb\u0027);\n          if (hit?.type === \u0027passive\u0027) types.push(\u0027analysis-passive\u0027);\n          if (hit?.type === \u0027longSentence\u0027) types.push(\u0027analysis-long-sentence\u0027);\n\n          return (\n            \u003cspan key={tokenIdx} className={types.join(\u0027 \u0027).trim()}\u003e\n              {token}\n            \u003c/span\u003e\n          );\n        })}\n      \u003c/p\u003e\n    );\n  };\n\n  return (\n    \u003carticle className=\"group relative overflow-hidden rounded-2xl border border-[#2f2822] bg-[#120f0c]/80 p-6 shadow-lg shadow-black/20 hover:-translate-y-1 hover:shadow-black/30 transition-all duration-200\"\u003e\n      \u003cheader className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\"\u003e\n        \u003cdiv className=\"space-y-2\"\u003e\n          \u003cdiv className=\"flex items-center gap-3 flex-wrap\"\u003e\n            \u003cdiv className=\"flex items-center gap-2\"\u003e\n              {isEditingTitle ? (\n                \u003cinput\n                  value={draftTitle}\n                  onChange={(e) =\u003e setDraftTitle(e.target.value)}\n                  className=\"text-2xl sm:text-3xl font-semibold text-[#fdfbf7] leading-tight bg-[#18130f] border border-[#2f2822] rounded-lg px-2 py-1\"\n                  placeholder={`Session #${id}`}\n                /\u003e\n              ) : (\n                \u003ch2 className=\"text-2xl sm:text-3xl font-semibold text-[#fdfbf7] leading-tight\"\u003e\n                  {title?.trim() || `Session #${id}`}\n                \u003c/h2\u003e\n              )}\n              \u003cbutton\n                type=\"button\"\n                onClick={handleSaveTitle}\n                disabled={disableActions}\n                className=\"text-xs rounded-lg border border-[#2f2822] bg-[#18130f] px-2 py-1 text-[#f7f4ed] hover:bg-[#211a13] disabled:opacity-50\"\n              \u003e\n                {isEditingTitle ? \u0027Speichern\u0027 : \u0027Titel bearbeiten\u0027}\n              \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cspan className=\"inline-flex items-center gap-2 rounded-full bg-[#1c1814] px-3 py-1 text-xs uppercase tracking-wide text-[#d6c9ba]\"\u003e\n              {statusLabels[status] ?? status}\n            \u003c/span\u003e\n            \u003cselect\n              value={status}\n              onChange={(e) =\u003e handleStatusChange(e.target.value as NonNullable\u003cSession[\u0027status\u0027]\u003e)}\n              disabled={disableActions}\n              className=\"rounded-lg border border-[#2f2822] bg-[#120f0c] px-2 py-1 text-xs disabled:opacity-50\"\n            \u003e\n              \u003coption value=\"draft\"\u003eRoh\u003c/option\u003e\n              \u003coption value=\"in_progress\"\u003eIn Arbeit\u003c/option\u003e\n              \u003coption value=\"revised\"\u003eÜberarbeitet\u003c/option\u003e\n              \u003coption value=\"final\"\u003eFinal\u003c/option\u003e\n            \u003c/select\u003e\n            {tags?.map((tag) =\u003e (\n              \u003cspan\n                key={tag}\n                className=\"inline-flex items-center rounded-full border border-[#2f2822] px-2.5 py-1 text-[11px] text-[#e8ded2] bg-[#17130f]\"\n              \u003e\n                {tag}\n                \u003cbutton\n                  type=\"button\"\n                  onClick={() =\u003e handleRemoveTag(tag)}\n                  disabled={disableActions}\n                  className=\"ml-1 text-[10px] text-[#9c8f82] hover:text-[#fdfbf7] disabled:opacity-50\"\n                  aria-label={`Tag ${tag} entfernen`}\n                \u003e\n                  ×\n                \u003c/button\u003e\n              \u003c/span\u003e\n            ))}\n          \u003c/div\u003e\n          \u003cdiv className=\"flex items-center gap-2 text-[12px] text-[#cbbfb0]\"\u003e\n            \u003cinput\n              value={newTag}\n              onChange={(e) =\u003e setNewTag(e.target.value)}\n              placeholder=\"Tag hinzufügen\"\n              className=\"bg-[#18130f] border border-[#2f2822] rounded-lg px-2 py-1 focus:outline-none\"\n              disabled={disableActions}\n            /\u003e\n            \u003cbutton\n              type=\"button\"\n              onClick={handleAddTag}\n              disabled={disableActions}\n              className=\"text-xs rounded-lg border border-[#2f2822] bg-[#18130f] px-2 py-1 text-[#f7f4ed] hover:bg-[#211a13] disabled:opacity-50\"\n            \u003e\n              Tag speichern\n            \u003c/button\u003e\n          \u003c/div\u003e\n          \u003cdiv className=\"text-sm text-[#cbbfb0] flex flex-wrap gap-3\"\u003e\n            \u003ctime dateTime={created_at}\u003e\n              {new Intl.DateTimeFormat(\u0027de-DE\u0027, { dateStyle: \u0027medium\u0027 }).format(\n                new Date(created_at),\n              )}\n            \u003c/time\u003e\n            {updated_at \u0026\u0026 (\n              \u003c\u003e\n                \u003cspan aria-hidden=\"true\"\u003e·\u003c/span\u003e\n                \u003cspan\u003e\n                  Aktualisiert:{\u0027 \u0027}\n                  {new Intl.DateTimeFormat(\u0027de-DE\u0027, { dateStyle: \u0027medium\u0027 }).format(\n                    new Date(updated_at),\n                  )}\n                \u003c/span\u003e\n              \u003c/\u003e\n            )}\n            \u003cspan aria-hidden=\"true\"\u003e嫉\u003c/span\u003e\n            \u003cspan\u003e{safeWordCount} Wörter\u003c/span\u003e\n            \u003cspan aria-hidden=\"true\"\u003e嫉\u003c/span\u003e\n            \u003cspan\u003e{safeCharCount} Zeichen\u003c/span\u003e\n            \u003cspan aria-hidden=\"true\"\u003e嫉\u003c/span\u003e\n            \u003cspan\u003e{safeLetterCount} Buchstaben\u003c/span\u003e\n            \u003cspan aria-hidden=\"true\"\u003e嫉\u003c/span\u003e\n            \u003cspan\u003e{Math.max(1, Math.round(safeWordCount / 180))} min Lesezeit\u003c/span\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv className=\"flex items-center gap-2 opacity-70 group-hover:opacity-100 sm:self-start\"\u003e\n          \u003cbutton\n            type=\"button\"\n            onClick={handleEdit}\n            className=\"inline-flex items-center gap-1 rounded-lg border border-[#2f2822] bg-[#18130f] px-3 py-2 text-xs font-semibold text-[#f7f4ed] hover:bg-[#211a13]\"\n          \u003e\n            \u003cEdit3 size={14} /\u003e Bearbeiten\n          \u003c/button\u003e\n          \u003cbutton\n            type=\"button\"\n            onClick={handleCopy}\n            className=\"inline-flex items-center gap-1 rounded-lg border border-[#2f2822] bg-[#18130f] px-3 py-2 text-xs font-semibold text-[#f7f4ed] hover:bg-[#211a13]\"\n          \u003e\n            \u003cCopy size={14} /\u003e {copied ? \u0027Kopiert\u0027 : \u0027Kopieren\u0027}\n          \u003c/button\u003e\n          \u003cspan className=\"sr-only\" aria-live=\"polite\"\u003e\n            {copied ? \u0027In die Zwischenablage kopiert.\u0027 : \u0027\u0027}\n          \u003c/span\u003e\n          \u003cbutton\n            type=\"button\"\n            className=\"inline-flex items-center rounded-lg border border-[#2f2822] bg-[#18130f] px-2 py-2 text-xs font-semibold text-[#f7f4ed] hover:bg-[#211a13]\"\n            aria-label=\"Mehr Aktionen\"\n          \u003e\n            \u003cMoreHorizontal size={16} /\u003e\n          \u003c/button\u003e\n        \u003c/div\u003e\n      \u003c/header\u003e\n\n      \u003cdiv className=\"mt-4 flex items-center gap-3 text-xs text-[#d6c9ba]\"\u003e\n        \u003cspan className=\"inline-flex items-center gap-1 rounded-full bg-[#18130f] px-2.5 py-1 border border-[#2f2822]\"\u003e\n          \u003cSparkles size={14} /\u003e Analyse: Verben {counts.verbs} · Nomen {counts.nouns} · Adjektive {counts.adjectives} · Adverbien {counts.adverbs}\n        \u003c/span\u003e\n        \u003cbutton\n          type=\"button\"\n          onClick={() =\u003e setShowAnalysis((v) =\u003e !v)}\n          aria-pressed={showAnalysis}\n          className=\"text-[11px] uppercase tracking-wide rounded-full border border-[#2f2822] px-3 py-1 hover:bg-[#18130f]\"\n        \u003e\n          {showAnalysis ? \u0027Markierungen aus\u0027 : \u0027Markierungen an\u0027}\n        \u003c/button\u003e\n      \u003c/div\u003e\n\n      \u003cdiv\n        className=\"mt-6 space-y-4 text-[18px] md:text-[19px] leading-[1.75] text-[#f7f4ed] font-serif\"\n        style={{ fontFeatureSettings: \u0027\"liga\",\"kern\"\u0027 }}\n      \u003e\n        {paragraphs.length \u003e 0\n          ? paragraphs.map((para, idx) =\u003e renderParagraph(para, idx))\n          : renderParagraph(text, 0)}\n      \u003c/div\u003e\n    \u003c/article\u003e\n  );\n}\n","sizeBytes":12968,"_type":"file","lastWriteTime":"2026-01-03T12:59:58.4769252+01:00","relativePath":"SessionItem.tsx","sha256":"CCD81EE267456B038276267D72A1DAB0DFADC42F4FE091EB508D9B18F3DA7D68","filePath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView\\SessionItem.tsx","language":"typescriptreact","extension":".tsx"}
{"lineCount":55,"fileName":"SessionList.tsx","content":"\u0027use client\u0027;\nimport React from \u0027react\u0027;\nimport type { Session } from \u0027./types\u0027;\n\ninterface SessionListProps {\n  sessions: Session[];\n  selectedId?: number;\n  onSelect: (session: Session) =\u003e void;\n}\n\nexport function SessionList({ sessions, selectedId, onSelect }: SessionListProps) {\n  if (sessions.length === 0) {\n    return \u003cp className=\"text-gray-400\"\u003eKeine Sessions gefunden.\u003c/p\u003e;\n  }\n\n  return (\n    \u003cul className=\"space-y-1\"\u003e\n      {sessions.map((session) =\u003e {\n        const isActive = session.id === selectedId;\n        const title = session.title?.trim() || `Session #${session.id}`;\n        const teaser =\n          session.text.length \u003e 120 ? `${session.text.slice(0, 120)}…` : session.text;\n\n        return (\n          \u003cli key={session.id}\u003e\n            \u003cbutton\n              onClick={() =\u003e onSelect(session)}\n              className={`w-full text-left rounded-md transition-all duration-120 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 ${\n                isActive\n                  ? \u0027bg-amber-100/70 text-amber-900\u0027\n                  : \u0027bg-transparent text-amber-50 hover:bg-amber-50/10\u0027\n              }`}\n            \u003e\n              \u003cdiv className=\"px-3 py-2\"\u003e\n                \u003cdiv className=\"flex items-center justify-between text-[12px] text-amber-200/90\"\u003e\n                  \u003cspan className=\"font-medium\"\u003e{title}\u003c/span\u003e\n                  \u003ctime dateTime={session.created_at}\u003e\n                    {new Date(session.created_at).toLocaleDateString()}\n                  \u003c/time\u003e\n                \u003c/div\u003e\n                \u003cp className=\"mt-1 text-[14px] leading-[1.55] text-amber-50 line-clamp-2\"\u003e\n                  {teaser}\n                \u003c/p\u003e\n                \u003cdiv className=\"mt-1 text-[11px] text-amber-200/70\"\u003e\n                  {session.word_count} Wörter · {session.char_count} Zeichen\n                \u003c/div\u003e\n              \u003c/div\u003e\n            \u003c/button\u003e\n          \u003c/li\u003e\n        );\n      })}\n    \u003c/ul\u003e\n  );\n}\n","sizeBytes":1944,"_type":"file","lastWriteTime":"2026-01-03T13:01:20.9492233+01:00","relativePath":"SessionList.tsx","sha256":"9B266C48D7390CFA1C2B6A85D773ED6F29B38F6DE174353DD2D4577130E46BDB","filePath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView\\SessionList.tsx","language":"typescriptreact","extension":".tsx"}
{"lineCount":179,"fileName":"SessionView.tsx","content":"\u0027use client\u0027;\nimport React, { useDeferredValue, useMemo, useState } from \u0027react\u0027;\nimport { Search, Filter, MoreHorizontal } from \u0027lucide-react\u0027;\nimport { useSessionData } from \u0027./useSessionData\u0027;\nimport { SessionItem } from \u0027./SessionItem\u0027;\nimport type { Session } from \u0027./types\u0027;\n\nexport function SessionView() {\n  const [search, setSearch] = useState(\u0027\u0027);\n  const deferredSearch = useDeferredValue(search);\n  const isSearching = search.trim().length \u003e 0;\n  const [sortBy, setSortBy] = useState\u003c\u0027newest\u0027 | \u0027oldest\u0027 | \u0027words\u0027 | \u0027letters\u0027\u003e(\n    \u0027newest\u0027,\n  );\n  const {\n    sessions,\n    pagination,\n    searchPage,\n    isLoading,\n    isLoadingMore,\n    isPending,\n    isUpdating,\n    hasMore,\n    error,\n    refreshSessions,\n    loadMore,\n    updateSession,\n  } = useSessionData({\n    pageSize: 50,\n    prefetchDelayMs: 1200,\n    autoPrefetch: !isSearching,\n    searchQuery: deferredSearch,\n  });\n\n  const filtered = useMemo(() =\u003e {\n    const sorted = [...sessions].sort((a, b) =\u003e {\n      switch (sortBy) {\n        case \u0027oldest\u0027:\n          return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();\n        case \u0027words\u0027:\n          return (b.word_count ?? 0) - (a.word_count ?? 0);\n        case \u0027letters\u0027:\n          return (b.letter_count ?? 0) - (a.letter_count ?? 0);\n        default:\n          return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();\n      }\n    });\n\n    return sorted;\n  }, [sessions, sortBy]);\n\r\n  return (\r\n    \u003cmain className=\"min-h-screen bg-[#0b0a09] text-[#f7f4ed]\"\u003e\r\n      \u003cdiv className=\"mx-auto max-w-6xl px-4 sm:px-6 py-14\"\u003e\r\n        \u003cheader className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-10\"\u003e\r\n          \u003cdiv className=\"space-y-2\"\u003e\r\n            \u003cp className=\"text-xs tracking-[0.25em] uppercase text-[#cbbfb0] font-semibold\"\u003e\r\n              Archiv\r\n            \u003c/p\u003e\r\n            \u003ch1 className=\"text-3xl sm:text-4xl font-semibold text-[#fdfbf7] leading-tight\"\u003e\r\n              Sessions als Blogposts\r\n            \u003c/h1\u003e\r\n            \u003cp className=\"text-sm text-[#d6c9ba] max-w-3xl\"\u003e\r\n              Schnell filtern, kopieren oder bearbeiten – mit optionaler Text-Analyse\r\n              pro Session.\r\n            \u003c/p\u003e\r\n          \u003c/div\u003e\r\n          \u003cdiv className=\"flex flex-col gap-3 sm:min-w-[280px]\"\u003e\n            \u003cdiv className=\"relative flex items-center gap-2 rounded-lg border border-[#2f2822] bg-[#120f0c] px-3 py-2\"\u003e\n              \u003cSearch size={18} className=\"text-[#cbbfb0]\" /\u003e\n              \u003cinput\n                value={search}\n                onChange={(e) =\u003e setSearch(e.target.value)}\n                placeholder=\"Suchen (Titel, Text, Tags)\"\n                className=\"bg-transparent outline-none text-sm placeholder:text-[#6f6259] flex-1\"\n              /\u003e\n            \u003c/div\u003e\n            {deferredSearch.trim() \u0026\u0026 (\n              \u003cp className=\"text-xs text-[#cbbfb0]\"\u003e\n                Suche laedt...\n                {searchPage.next_cursor\n                  ? ` (${sessions.length}+ Treffer...)`\n                  : ` (${sessions.length} Treffer)`}\n                {isPending ? \u0027 - aktualisiere\u0027 : \u0027\u0027}\n              \u003c/p\u003e\n            )}\n            \u003cdiv className=\"flex items-center gap-2 justify-end text-sm text-[#d6c9ba]\"\u003e\n              \u003cFilter size={16} /\u003e\n              \u003clabel htmlFor=\"sort\" className=\"sr-only\"\u003e\r\n                Sortierung\r\n              \u003c/label\u003e\r\n              \u003cselect\r\n                id=\"sort\"\r\n                value={sortBy}\r\n                onChange={(e) =\u003e setSortBy(e.target.value as typeof sortBy)}\r\n                className=\"rounded-lg border border-[#2f2822] bg-[#120f0c] px-3 py-2 focus:outline-none\"\r\n              \u003e\r\n                \u003coption value=\"newest\"\u003eNeueste zuerst\u003c/option\u003e\r\n                \u003coption value=\"oldest\"\u003eÄlteste zuerst\u003c/option\u003e\r\n                \u003coption value=\"words\"\u003eNach Wörteranzahl\u003c/option\u003e\r\n                \u003coption value=\"letters\"\u003eNach Buchstaben\u003c/option\u003e\r\n              \u003c/select\u003e\r\n            \u003c/div\u003e\r\n          \u003c/div\u003e\r\n        \u003c/header\u003e\r\n\r\n        \u003cdiv className=\"flex items-center gap-3 mb-6\"\u003e\r\n          \u003cbutton\r\n            onClick={refreshSessions}\r\n            disabled={isLoading}\r\n            className=\"inline-flex items-center gap-2 rounded-lg border border-[#3a3129] px-3 py-2 text-sm text-[#f7f4ed] hover:bg-[#191511] focus:outline-none focus-visible:ring-2 focus-visible:ring-[#c9b18a] disabled:opacity-50\"\r\n          \u003e\r\n            {isLoading ? \u0027Aktualisiere...\u0027 : \u0027Neu laden\u0027}\r\n          \u003c/button\u003e\r\n          {error \u0026\u0026 (\r\n            \u003cspan className=\"text-sm text-red-300 bg-red-950/60 border border-red-900/60 px-3 py-2 rounded-lg\"\u003e\r\n              {error}\r\n            \u003c/span\u003e\r\n          )}\r\n        \u003c/div\u003e\r\n\r\n        {error \u0026\u0026 (\r\n          \u003cdiv className=\"mb-6 rounded-lg border border-red-900/60 bg-red-950/60 text-red-100 px-4 py-3\"\u003e\r\n            Fehler: {error}\r\n          \u003c/div\u003e\r\n        )}\r\n\r\n        \u003csection className=\"space-y-4\"\u003e\r\n          {isLoading \u0026\u0026 sessions.length === 0 ? (\r\n            \u003cp className=\"text-[#d6c9ba]\"\u003eLade Sessions...\u003c/p\u003e\r\n          ) : filtered.length === 0 ? (\r\n            \u003cp className=\"text-[#d6c9ba]\"\u003eKeine Sessions gefunden.\u003c/p\u003e\n          ) : (\n            filtered.map((session: Session) =\u003e (\n              \u003cSessionItem\n                key={session.id}\n                session={session}\n                onUpdate={updateSession}\n                disableActions={isUpdating}\n              /\u003e\n            ))\n          )}\n        \u003c/section\u003e\n\r\n        \u003cdiv className=\"mt-10 flex items-center justify-between text-sm text-[#d6c9ba]\"\u003e\r\n          \u003cspan\u003e\n            {deferredSearch.trim()\n              ? searchPage.next_cursor\n                ? `${sessions.length}+ Treffer`\n                : `${sessions.length} Treffer`\n              : pagination.total\n                ? `${sessions.length} von ${pagination.total} Eintraegen`\n                : `${sessions.length} Eintraege`}\n          \u003c/span\u003e\n          \u003cdiv className=\"flex items-center gap-3\"\u003e\r\n            {hasMore \u0026\u0026 (\r\n              \u003cbutton\r\n                onClick={loadMore}\r\n                disabled={isLoadingMore}\r\n                className=\"inline-flex items-center gap-2 rounded-lg border border-[#3a3129] px-3 py-2 text-sm text-[#f7f4ed] hover:bg-[#191511] focus:outline-none focus-visible:ring-2 focus-visible:ring-[#c9b18a] disabled:opacity-50\"\r\n              \u003e\r\n                {isLoadingMore ? \u0027Lade mehr...\u0027 : \u0027Weitere Sessions laden\u0027}\r\n              \u003c/button\u003e\r\n            )}\r\n            \u003cbutton\r\n              className=\"inline-flex items-center gap-2 rounded-lg border border-[#2f2822] px-3 py-2 text-sm text-[#f7f4ed] hover:bg-[#191511]\"\r\n              type=\"button\"\r\n              aria-label=\"Weitere Optionen\"\r\n            \u003e\r\n              \u003cMoreHorizontal size={16} /\u003e\r\n              Mehr\r\n            \u003c/button\u003e\r\n          \u003c/div\u003e\r\n        \u003c/div\u003e\r\n      \u003c/div\u003e\r\n    \u003c/main\u003e\r\n  );\r\n}\r\n","sizeBytes":6875,"_type":"file","lastWriteTime":"2026-01-03T16:04:38.8665846+01:00","relativePath":"SessionView.tsx","sha256":"0A7C8DF1BD1F4C84C1436E2B5B7C87C8A90FDC9173B087D7CF20FDEDB8D7182D","filePath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView\\SessionView.tsx","language":"typescriptreact","extension":".tsx"}
{"lineCount":26,"fileName":"types.ts","content":"export interface Session {\n  id: number;\n  title?: string | null;\n  text: string;\n  created_at: string;\n  updated_at?: string;\n  word_count: number;\n  char_count: number;\n  letter_count: number;\n  status?: \u0027draft\u0027 | \u0027in_progress\u0027 | \u0027revised\u0027 | \u0027final\u0027;\n  tags?: string[];\n}\n\nexport interface SessionPagination {\n  limit: number;\n  offset: number;\n  total: number;\n}\n\nexport interface SearchPagination {\n  limit: number;\n  cursor?: string | null;\n  next_cursor?: string | null;\n  total?: number;\n}\n","sizeBytes":497,"_type":"file","lastWriteTime":"2026-01-03T16:02:58.1804766+01:00","relativePath":"types.ts","sha256":"B1C632A6D0B300AE857A5CFB2486BF9AADC7FCF389C7CC1B06A8E05754064A75","filePath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView\\types.ts","language":"typescript","extension":".ts"}
{"lineCount":425,"fileName":"useSessionData.ts","content":"\u0027use client\u0027;\nimport { useCallback, useEffect, useRef, useState, useTransition } from \u0027react\u0027;\nimport type { SearchPagination, Session, SessionPagination } from \u0027./types\u0027;\n\nconst DEFAULT_API_BASE_URL = \u0027/api\u0027;\nconst API_BASE_URL = (\n  process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE_URL\n).replace(/\\/$/, \u0027\u0027);\nconst API_HEADERS: Record\u003cstring, string\u003e = {\n  \u0027Content-Type\u0027: \u0027application/json\u0027,\n};\n\ntype SessionsResponse = {\n  success: boolean;\n  data?: Session[];\n  pagination?: SessionPagination;\n  error?: string;\n  message?: string;\n};\n\ntype SearchPageResponse = {\n  success: boolean;\n  data?: SessionPayload[];\n  pagination?: SearchPagination;\n  error?: string;\n  message?: string;\n};\n\ntype UpdateSessionPayload = Partial\u003c\n  Pick\u003cSession, \u0027title\u0027 | \u0027status\u0027 | \u0027tags\u0027\u003e\n\u003e;\n\ntype UseSessionDataOptions = {\n  pageSize?: number;\n  prefetchDelayMs?: number;\n  autoPrefetch?: boolean;\n  searchQuery?: string;\n};\n\ntype SessionPayload = Session \u0026 { text_preview?: string; tags?: string[] };\n\nconst normalizeSession = (entry: SessionPayload): Session =\u003e {\n  return {\n    ...entry,\n    text: entry.text ?? entry.text_preview ?? \u0027\u0027,\n    tags: entry.tags ?? [],\n    status: entry.status ?? \u0027draft\u0027,\n  };\n};\n\nconst buildApiUrl = (\n  path: string,\n  query?: Record\u003cstring, string | number | undefined\u003e,\n) =\u003e {\n  const normalizedPath = path.startsWith(\u0027/\u0027) ? path : `/${path}`;\n  const params = new URLSearchParams();\n  if (query) {\n    for (const [key, value] of Object.entries(query)) {\n      if (value !== undefined) {\n        params.set(key, String(value));\n      }\n    }\n  }\n  const queryString = params.toString();\n  return `${API_BASE_URL}${normalizedPath}${queryString ? `?${queryString}` : \u0027\u0027}`;\n};\n\nexport function useSessionData(options: UseSessionDataOptions = {}) {\n  const pageSize = options.pageSize ?? 50;\n  const prefetchDelayMs = options.prefetchDelayMs ?? 1200;\n  const autoPrefetch = options.autoPrefetch ?? true;\n  const searchQuery = options.searchQuery?.trim() ?? \u0027\u0027;\n\n  const [sessions, setSessions] = useState\u003cSession[]\u003e([]);\n  const [pagination, setPagination] = useState\u003cSessionPagination\u003e(() =\u003e ({\n    limit: pageSize,\n    offset: 0,\n    total: 0,\n  }));\n  const [searchPage, setSearchPage] = useState\u003cSearchPagination\u003e(() =\u003e ({\n    limit: pageSize,\n    cursor: null,\n    next_cursor: null,\n  }));\n\n  const [isLoading, setIsLoading] = useState(false);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [error, setError] = useState\u003cstring | null\u003e(null);\n\n  const [isPending, startTransition] = useTransition();\n\n  const abortRef = useRef\u003cAbortController | null\u003e(null);\n  const prefetchTimerRef = useRef\u003cnumber | null\u003e(null);\n  const byIdRef = useRef\u003cMap\u003cnumber, Session\u003e\u003e(new Map());\n  const loadingRef = useRef(false);\n  const loadingMoreRef = useRef(false);\n  const modeRef = useRef\u003c\u0027list\u0027 | \u0027search\u0027\u003e(\u0027list\u0027);\n  const lastQueryRef = useRef(searchQuery);\n\n  const mergeSessions = useCallback(\n    (incoming: Session[], append: boolean) =\u003e {\n      if (!append) {\n        byIdRef.current = new Map();\n      }\n      for (const session of incoming) {\n        byIdRef.current.set(session.id, session);\n      }\n      const merged = Array.from(byIdRef.current.values());\n      startTransition(() =\u003e setSessions(merged));\n      return merged.length;\n    },\n    [startTransition],\n  );\n\n  const fetchListPage = useCallback(\n    async (offsetToLoad: number, append: boolean, silent = false) =\u003e {\n      if (!silent) {\n        setError(null);\n        if (append) {\n          loadingMoreRef.current = true;\n          setIsLoadingMore(true);\n        } else {\n          loadingRef.current = true;\n          setIsLoading(true);\n        }\n      }\n\n      abortRef.current?.abort();\n      const controller = new AbortController();\n      abortRef.current = controller;\n\n      try {\n        const response = await fetch(\n          buildApiUrl(\u0027/sessions\u0027, {\n            limit: pageSize,\n            offset: offsetToLoad,\n          }),\n          {\n            method: \u0027GET\u0027,\n            headers: API_HEADERS,\n            cache: \u0027no-store\u0027,\n            signal: controller.signal,\n          },\n        );\n        const json = (await response.json()) as SessionsResponse;\n        if (!response.ok || !json.success || !json.data) {\n          const message =\n            (!json.success \u0026\u0026 (json.error || json.message)) ||\n            json.message ||\n            \u0027Sessions konnten nicht geladen werden.\u0027;\n          throw new Error(message);\n        }\n        const normalized = json.data.map(normalizeSession);\n        const nextPagination: SessionPagination = {\n          limit: json.pagination?.limit ?? pageSize,\n          offset: json.pagination?.offset ?? offsetToLoad,\n          total: json.pagination?.total ?? offsetToLoad + normalized.length,\n        };\n        startTransition(() =\u003e setPagination(nextPagination));\n        mergeSessions(normalized, append);\n        return { ok: true as const, total: nextPagination.total };\n      } catch (err) {\n        if ((err as { name?: string }).name === \u0027AbortError\u0027) {\n          return { ok: false as const, aborted: true as const };\n        }\n        const message =\n          err instanceof Error\n            ? err.message\n            : \u0027Unbekannter Fehler beim Laden der Sessions.\u0027;\n        if (!silent) setError(message);\n        return { ok: false as const, message };\n      } finally {\n        if (!silent) {\n          loadingRef.current = false;\n          loadingMoreRef.current = false;\n          setIsLoading(false);\n          setIsLoadingMore(false);\n        }\n      }\n    },\n    [mergeSessions, pageSize, startTransition],\n  );\n\n  const fetchSearchPage = useCallback(\n    async (cursor: string | null, append: boolean, silent = false) =\u003e {\n      if (!silent) {\n        setError(null);\n        if (append) {\n          loadingMoreRef.current = true;\n          setIsLoadingMore(true);\n        } else {\n          loadingRef.current = true;\n          setIsLoading(true);\n        }\n      }\n\n      abortRef.current?.abort();\n      const controller = new AbortController();\n      abortRef.current = controller;\n\n      try {\n        const response = await fetch(\n          buildApiUrl(\u0027/sessions/search\u0027, {\n            q: searchQuery,\n            limit: pageSize,\n            cursor: cursor ?? undefined,\n            sort: \u0027created_at\u0027,\n            order: \u0027desc\u0027,\n          }),\n          {\n            method: \u0027GET\u0027,\n            headers: API_HEADERS,\n            cache: \u0027no-store\u0027,\n            signal: controller.signal,\n          },\n        );\n        const json = (await response.json()) as SearchPageResponse;\n        if (!response.ok || !json.success || !json.data) {\n          const message =\n            (!json.success \u0026\u0026 (json.error || json.message)) ||\n            json.message ||\n            \u0027Sessions konnten nicht geladen werden.\u0027;\n          throw new Error(message);\n        }\n        const normalized = json.data.map(normalizeSession);\n        const nextPagination: SearchPagination = {\n          limit: json.pagination?.limit ?? pageSize,\n          cursor: cursor ?? null,\n          next_cursor: json.pagination?.next_cursor ?? null,\n        };\n        startTransition(() =\u003e setSearchPage(nextPagination));\n        mergeSessions(normalized, append);\n        return { ok: true as const, total: nextPagination.total };\n      } catch (err) {\n        if ((err as { name?: string }).name === \u0027AbortError\u0027) {\n          return { ok: false as const, aborted: true as const };\n        }\n        const message =\n          err instanceof Error\n            ? err.message\n            : \u0027Unbekannter Fehler beim Laden der Sessions.\u0027;\n        if (!silent) setError(message);\n        return { ok: false as const, message };\n      } finally {\n        if (!silent) {\n          loadingRef.current = false;\n          loadingMoreRef.current = false;\n          setIsLoading(false);\n          setIsLoadingMore(false);\n        }\n      }\n    },\n    [mergeSessions, pageSize, searchQuery, startTransition],\n  );\n\n  const stopPrefetch = useCallback(() =\u003e {\n    if (prefetchTimerRef.current === null) return;\n    if (typeof window !== \u0027undefined\u0027) {\n      window.clearTimeout(prefetchTimerRef.current);\n    }\n    prefetchTimerRef.current = null;\n  }, []);\n\n  const schedulePrefetchTick = useCallback(() =\u003e {\n    stopPrefetch();\n    if (typeof window === \u0027undefined\u0027) return;\n    if (modeRef.current !== \u0027list\u0027) return;\n\n    prefetchTimerRef.current = window.setTimeout(async () =\u003e {\n      if (!autoPrefetch) return;\n      if (loadingRef.current || loadingMoreRef.current) {\n        schedulePrefetchTick();\n        return;\n      }\n      if (typeof document !== \u0027undefined\u0027 \u0026\u0026 document.visibilityState === \u0027hidden\u0027) {\n        schedulePrefetchTick();\n        return;\n      }\n      if (sessions.length \u003e= pagination.total) return;\n\n      const nextOffset = pagination.offset + pagination.limit;\n      await fetchListPage(nextOffset, true, true);\n      schedulePrefetchTick();\n    }, prefetchDelayMs);\n  }, [autoPrefetch, fetchListPage, pagination.limit, pagination.offset, pagination.total, prefetchDelayMs, sessions.length, stopPrefetch]);\n\n  const refreshSessions = useCallback(async () =\u003e {\n    stopPrefetch();\n    byIdRef.current = new Map();\n    startTransition(() =\u003e setSessions([]));\n\n    if (searchQuery) {\n      modeRef.current = \u0027search\u0027;\n      setSearchPage({ limit: pageSize, cursor: null, next_cursor: null });\n      return fetchSearchPage(null, false);\n    }\n\n    modeRef.current = \u0027list\u0027;\n    setPagination({ limit: pageSize, offset: 0, total: 0 });\n    return fetchListPage(0, false);\n  }, [fetchListPage, fetchSearchPage, pageSize, searchQuery, stopPrefetch, startTransition]);\n\n  const loadMore = useCallback(() =\u003e {\n    if (isLoading || isLoadingMore) return;\n    stopPrefetch();\n\n    if (modeRef.current === \u0027search\u0027) {\n      if (!searchPage.next_cursor) return;\n      return fetchSearchPage(searchPage.next_cursor, true);\n    }\n\n    if (sessions.length \u003e= pagination.total) return;\n    const nextOffset = pagination.offset + pagination.limit;\n    return fetchListPage(nextOffset, true);\n  }, [\n    fetchListPage,\n    fetchSearchPage,\n    isLoading,\n    isLoadingMore,\n    pagination.limit,\n    pagination.offset,\n    pagination.total,\n    searchPage.next_cursor,\n    sessions.length,\n    stopPrefetch,\n  ]);\n\n  const updateSession = useCallback(\n    async (id: number, payload: UpdateSessionPayload) =\u003e {\n      const body: Record\u003cstring, unknown\u003e = {};\n      if (payload.title !== undefined) body.title = payload.title;\n      if (payload.status !== undefined) body.status = payload.status;\n      if (payload.tags !== undefined) body.tags = payload.tags;\n      if (Object.keys(body).length === 0) return { success: false as const };\n\n      setIsUpdating(true);\n      setError(null);\n      try {\n        const res = await fetch(buildApiUrl(`/sessions/${id}`), {\n          method: \u0027PATCH\u0027,\n          headers: API_HEADERS,\n          body: JSON.stringify(body),\n        });\n        const json = (await res.json()) as {\n          success: boolean;\n          data?: Session;\n          error?: string;\n          message?: string;\n        };\n        if (!res.ok || !json.success || !json.data) {\n          throw new Error(json.error || json.message || \u0027Update fehlgeschlagen.\u0027);\n        }\n        const updated = normalizeSession(json.data as SessionPayload);\n        const existing = byIdRef.current.get(id);\n        const merged: Session = { ...(existing ?? ({} as Session)), ...updated };\n        byIdRef.current.set(id, merged);\n        startTransition(() =\u003e setSessions(Array.from(byIdRef.current.values())));\n        return { success: true as const, session: merged };\n      } catch (err) {\n        const message =\n          err instanceof Error ? err.message : \u0027Unbekannter Fehler beim Update.\u0027;\n        setError(message);\n        return { success: false as const, error: message };\n      } finally {\n        setIsUpdating(false);\n      }\n    },\n    [startTransition],\n  );\n\n  useEffect(() =\u003e {\n    if (searchQuery === lastQueryRef.current) return;\n    lastQueryRef.current = searchQuery;\n    void refreshSessions();\n  }, [refreshSessions, searchQuery]);\n\n  useEffect(() =\u003e {\n    void refreshSessions();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  useEffect(() =\u003e {\n    if (modeRef.current !== \u0027list\u0027) {\n      stopPrefetch();\n      return;\n    }\n    if (!autoPrefetch) return;\n    if (isLoading || isLoadingMore) return;\n    if (!pagination.total) return;\n    if (sessions.length \u003e= pagination.total) return;\n\n    schedulePrefetchTick();\n    return stopPrefetch;\n  }, [\n    autoPrefetch,\n    isLoading,\n    isLoadingMore,\n    pagination.total,\n    sessions.length,\n    schedulePrefetchTick,\n    stopPrefetch,\n  ]);\n\n  const hasMore =\n    modeRef.current === \u0027search\u0027\n      ? Boolean(searchPage.next_cursor)\n      : sessions.length \u003c pagination.total;\n\n  return {\n    sessions,\n    pagination,\n    searchPage,\n    hasMore,\n    isLoading,\n    isLoadingMore,\n    isUpdating,\n    isPending,\n    error,\n    refreshSessions,\n    loadMore,\n    updateSession,\n  };\n}\n","sizeBytes":13114,"_type":"file","lastWriteTime":"2026-01-03T16:04:26.9635772+01:00","relativePath":"useSessionData.ts","sha256":"526576BC3571FCF50F527915032B2425DAE501B957742AFD57B3F29DE11B336B","filePath":"E:\\ambrecht2024\\ambrecht\\components\\SessionView\\useSessionData.ts","language":"typescript","extension":".ts"}
{"finishedAt":"2026-01-28T14:23:17.3421379+01:00","_type":"codebase_footer","skipped":0,"fileCount":5}
